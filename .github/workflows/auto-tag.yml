name: Auto-Tag Release

on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  auto-tag:
    name: Create Release Tag
    if: |
      github.event.pull_request.merged == true &&
      github.event.pull_request.head.ref == 'dev'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Calculate version
        id: version
        run: |
          # Get last tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "Last tag: $LAST_TAG"
          
          # Analyze commits since last tag
          if [ "$LAST_TAG" = "v0.0.0" ]; then
            COMMIT_LOG=$(git log --oneline)
          else
            COMMIT_LOG=$(git log ${LAST_TAG}..HEAD --oneline)
          fi
          
          # Check for feat: commits
          FEAT_COUNT=$(echo "$COMMIT_LOG" | grep -cE "^[a-f0-9]+ feat(\(.+\))?:" || echo "0")
          
          # Check for breaking changes
          if [ "$LAST_TAG" = "v0.0.0" ]; then
            BREAKING_COUNT=$(git log --oneline --grep="BREAKING CHANGE" | wc -l | tr -d ' ')
          else
            BREAKING_COUNT=$(git log ${LAST_TAG}..HEAD --oneline --grep="BREAKING CHANGE" | wc -l | tr -d ' ')
          fi
          
          echo "Feature commits: $FEAT_COUNT"
          echo "Breaking changes: $BREAKING_COUNT"
          
          # Determine bump
          if [ "$BREAKING_COUNT" -gt 0 ]; then
            BUMP="MAJOR"
          elif [ "$FEAT_COUNT" -gt 0 ]; then
            BUMP="MINOR"
          else
            BUMP="PATCH"
          fi
          
          # Calculate new version
          MAJOR=$(echo $LAST_TAG | sed 's/v//' | cut -d. -f1)
          MINOR=$(echo $LAST_TAG | sed 's/v//' | cut -d. -f2)
          PATCH=$(echo $LAST_TAG | sed 's/v//' | cut -d. -f3)
          
          case $BUMP in
            MAJOR) NEW_TAG="v$((MAJOR+1)).0.0" ;;
            MINOR) NEW_TAG="v${MAJOR}.$((MINOR+1)).0" ;;
            PATCH) NEW_TAG="v${MAJOR}.${MINOR}.$((PATCH+1))" ;;
          esac
          
          echo "new_tag=$NEW_TAG" >> $GITHUB_OUTPUT
          echo "bump=$BUMP" >> $GITHUB_OUTPUT
          echo "New version: $NEW_TAG (${BUMP} bump)"
      
      - name: Create and push tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a ${{ steps.version.outputs.new_tag }} -m "Release ${{ steps.version.outputs.new_tag }}"
          git push origin ${{ steps.version.outputs.new_tag }}
      
      - name: Create GitHub Release
        uses: actions/github-script@v7
        with:
          script: |
            const release = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: '${{ steps.version.outputs.new_tag }}',
              name: 'Release ${{ steps.version.outputs.new_tag }}',
              body: `## Release ${{ steps.version.outputs.new_tag }}

            **Version bump:** ${{ steps.version.outputs.bump }}

            This release was created automatically after merging \`dev\` into \`main\`.

            **Release PR:** #${{ github.event.pull_request.number }}

            ---

            See [CHANGELOG](https://github.com/${context.repo.owner}/${context.repo.repo}/compare/${{ steps.version.outputs.new_tag }}...HEAD) for details.`,
              draft: false,
              prerelease: '${{ steps.version.outputs.new_tag }}'.startsWith('v0.')
            });
            
            console.log(`Created release: ${release.data.html_url}`);
      
      - name: Close Release Candidate issue
        uses: actions/github-script@v7
        with:
          script: |
            // Find open release-candidate issues
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'release-candidate',
              state: 'open'
            });
            
            for (const issue of issues.data) {
              // Add completion comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `Released as \`${{ steps.version.outputs.new_tag }}\`.\n\nGitHub Release: https://github.com/${context.repo.owner}/${context.repo.repo}/releases/tag/${{ steps.version.outputs.new_tag }}`
              });
              
              // Close the issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed',
                state_reason: 'completed'
              });
              
              console.log(`Closed release candidate issue #${issue.number}`);
            }

