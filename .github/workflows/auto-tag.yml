name: Auto-Tag Release

on:
  pull_request:
    types: [closed]
    branches: [main]

permissions:
  contents: write

jobs:
  auto-tag:
    name: Create Release Tag
    if: |
      github.event.pull_request.merged == true &&
      github.event.pull_request.head.ref == 'dev'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Calculate version
        id: version
        run: |
          # Get last tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "Last tag: $LAST_TAG"
          
          # Analyze commits since last tag
          if [ "$LAST_TAG" = "v0.0.0" ]; then
            COMMIT_LOG=$(git log --oneline)
          else
            COMMIT_LOG=$(git log ${LAST_TAG}..HEAD --oneline)
          fi
          
          # Check for feat: commits
          FEAT_COUNT=$(echo "$COMMIT_LOG" | grep -cE "^[a-f0-9]+ feat(\(.+\))?:" || echo "0")
          
          # Check for breaking changes (both BREAKING CHANGE in body and feat!/fix! notation)
          if [ "$LAST_TAG" = "v0.0.0" ]; then
            BREAKING_COUNT=$(git log --oneline --grep="BREAKING CHANGE" | wc -l | tr -d ' ')
            BREAKING_BANG=$(echo "$COMMIT_LOG" | grep -cE "^[a-f0-9]+ (feat|fix)(\(.+\))?!:" || echo "0")
          else
            BREAKING_COUNT=$(git log ${LAST_TAG}..HEAD --oneline --grep="BREAKING CHANGE" | wc -l | tr -d ' ')
            BREAKING_BANG=$(echo "$COMMIT_LOG" | grep -cE "^[a-f0-9]+ (feat|fix)(\(.+\))?!:" || echo "0")
          fi
          HAS_BREAKING=$((BREAKING_COUNT + BREAKING_BANG))
          
          echo "Feature commits: $FEAT_COUNT"
          echo "Breaking changes: $HAS_BREAKING (body: $BREAKING_COUNT, bang: $BREAKING_BANG)"
          
          # Determine bump
          if [ "$HAS_BREAKING" -gt 0 ]; then
            BUMP="MAJOR"
          elif [ "$FEAT_COUNT" -gt 0 ]; then
            BUMP="MINOR"
          else
            BUMP="PATCH"
          fi
          
          # Calculate new version
          MAJOR=$(echo $LAST_TAG | sed 's/v//' | cut -d. -f1)
          MINOR=$(echo $LAST_TAG | sed 's/v//' | cut -d. -f2)
          PATCH=$(echo $LAST_TAG | sed 's/v//' | cut -d. -f3)
          
          case $BUMP in
            MAJOR) NEW_TAG="v$((MAJOR+1)).0.0" ;;
            MINOR) NEW_TAG="v${MAJOR}.$((MINOR+1)).0" ;;
            PATCH) NEW_TAG="v${MAJOR}.${MINOR}.$((PATCH+1))" ;;
          esac
          
          echo "new_tag=$NEW_TAG" >> $GITHUB_OUTPUT
          echo "last_tag=$LAST_TAG" >> $GITHUB_OUTPUT
          echo "bump=$BUMP" >> $GITHUB_OUTPUT
          echo "New version: $NEW_TAG (${BUMP} bump)"
      
      - name: Create and push tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a ${{ steps.version.outputs.new_tag }} -m "Release ${{ steps.version.outputs.new_tag }}"
          git push origin ${{ steps.version.outputs.new_tag }}
      
      - name: Create GitHub Release
        uses: actions/github-script@v7
        env:
          NEW_TAG: ${{ steps.version.outputs.new_tag }}
          LAST_TAG: ${{ steps.version.outputs.last_tag }}
          BUMP_TYPE: ${{ steps.version.outputs.bump }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        with:
          script: |
            const newTag = process.env.NEW_TAG;
            const lastTag = process.env.LAST_TAG;
            const bumpType = process.env.BUMP_TYPE;
            const prNumber = process.env.PR_NUMBER;
            const isPrerelease = newTag.startsWith('v0.');
            
            // Build changelog link: compare previous tag to new tag
            const changelogUrl = lastTag === 'v0.0.0'
              ? `https://github.com/${context.repo.owner}/${context.repo.repo}/commits/${newTag}`
              : `https://github.com/${context.repo.owner}/${context.repo.repo}/compare/${lastTag}...${newTag}`;
            
            const release = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: newTag,
              name: `Release ${newTag}`,
              body: `## Release ${newTag}

            **Version bump:** ${bumpType}

            This release was created automatically after merging \`dev\` into \`main\`.

            **Release PR:** #${prNumber}

            ---

            See [CHANGELOG](${changelogUrl}) for details.`,
              draft: false,
              prerelease: isPrerelease
            });
            
            console.log(`Created release: ${release.data.html_url}`);
      
      - name: Close Release Candidate issue
        uses: actions/github-script@v7
        env:
          NEW_TAG: ${{ steps.version.outputs.new_tag }}
        with:
          script: |
            const newTag = process.env.NEW_TAG;
            
            // Find open release-candidate issues
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'release-candidate',
              state: 'open'
            });
            
            for (const issue of issues.data) {
              // Add completion comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `Released as \`${newTag}\`.\n\nGitHub Release: https://github.com/${context.repo.owner}/${context.repo.repo}/releases/tag/${newTag}`
              });
              
              // Close the issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed',
                state_reason: 'completed'
              });
              
              console.log(`Closed release candidate issue #${issue.number}`);
            }

